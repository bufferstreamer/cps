
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>聊天</title>
    <style>
        @import url('https://fonts.googleapis.com css2?family-Open+Sans:wght@300;400;00;600;700&display=swap');
        *
        {
            margin: 0;padding: 0;
            box-sizing: border-box;
            font-family: 'Open Sans' ,sans-serif;
        }
        body
        {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(#009688 0%,#009688 130px,#d9dbd5 130px,#d9dbd5 100%)
        }
        .picture {
            margin-top: 50px;
            margin-left: 50px;
            width: 50px;
            height: 50px;
        }
        .badge {
            width: 20px;
            height: 20px;
            line-height: 20px;  /* 数值与height相同，使数字垂直居中 */
            text-align: center;
            background-color: red;
            color: white;
            font-size: 12px;
            font-weight: 700;
            border-radius: 50%;
            position: relative;
            /*bottom: 60px;*/
            /*left: 90px;*/
        }
        .container
        {
            position: relative;
            width: 1396px;
            max-width: 100%;
            height: calc( 100vh - 40px);
            background:#fff;
            box-shadow: 0 1px 1px 0 rgba(0,0,0,0.06),0 2px 5px 0 rgba(0,0,0,0.06);
            display: flex;
        }
        .container .leftSide
        {
            position: relative;
            flex:30%;
            background:#fff;
            border-right: 1px solid rgba(0, 0, 0, 0.2);
        }
        .container .rightside
        {
            position: relative;
            flex: 70%;
            background:#e5ddd5;
        }
        .container .rightside::before
        {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /*background:url(img6-bg.jpg) ;*/
            opacity: 0.06;
        }
        .header
        {
            position: relative;
            width: 100%;
            height: 60px;
            background: #ededed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
        }
        .userimg
        {
            position: relative;
            width: 40px;
            height: 40px;
            overflow: hidden;
            border-radius: 50%;
            cursor: pointer;
        }
        .cover
        {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .nav_icons
        {
            display: flex;
        }
        .nav_icons li
        {
            display: flex;
            list-style: none;
            cursor: pointer;
            color: #51585c;
            font-size: 1.5em;
            margin-left: 22px;
        }
        .search_chat
        {
            position: relative;
            width: 100%;
            height: 50px;
            background: #f6f6f6;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 15px;
        }
        .search_chat div
        {
            width: 100%;
        }
        .search_chat div input
        {
            width:100%;
            outline: none;
            border: none;
            background: #fff;
            padding: 6px;
            height: 38px;
            border-radius: 30px;
            font-size: 14px;
            padding-left: 40px;
        }
        .search_chat div input::placeholder
        {
            color: #bbb;
        }
        .search_chat div img
        {
            position: absolute;
            left: 30px;
            top: 14px;
            font-size: 1.5em;
        }
        .chatlist
        {
            position: relative;
            height: calc(100%- 110px);
            overflow-y: auto;
        }
        .chatlist .block
        {
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }
        .chatlist .block.active{
            background: #ebebeb;
        }
        .chatlist .block:hover
        {
            background:#f5f5f5;
        }
        .chatlist .block .imgbx
        {
            position: relative;
            min-width: 45px;
            height: 45px;
            overflow: hidden;
            border-radius: 50%;
            margin-right: 10px;
        }
        .chatlist .block .details
        {
            position: relative;
            width: 100%;
        }
        .chatlist .block .details .listHead
        {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .chatlist .block .details .listHead h4
        {
            font-size: 1.1em;
            font-weight: 600;
            color: #111;
        }
        .chatlist .block .details .listHead .time
        {
            font-size: 0.75em;
            color: #aaa;
        }
        .chatlist .block .details .listHead .time
        {
            color: #111;
        }

        .message_p
        {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .message_p p
        {
            color: #aaa;
            display: -webkit-box;
            /*-webkit-line-break: 1;*/
            font-size: 0.9em;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .message_p b
        {
            background-color: red;
            color: #fff;
            min-width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.75em;
        }
        .imgText
        {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .imgText h4
        {
            font-weight: 500;
            line-height: 1.2em;
            margin-left: 15px;
        }
        .imgText h4 span
        {
            font-size: 0.8em;
            color: #555;
        }
        .chatBox
        {
            position: relative;
            width: 100%;
            height: calc(100% - 120px);
            padding: 50px;
            overflow-y: auto;
        }
        .message
        {
            position: relative;
            display: flex;
            width: 100%;
            margin: 5px 0;
        }
        .message p
        {
            position: relative;
            right: 0;
            text-align: right;
            max-width: 65%;
            padding: 12px;
            background: #dcf8c6;
            border-radius: 10px;
            font-size: 0.9em;
        }
        .message p::before
        {
            content: '';
            position: absolute;
            top: 0;
            right: -12px;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg,#dcf8c6 0%,#dcf8c6 50%,transparent 50%,transparent);
        }
        .message p span
        {
            display: block;
            margin-top: 5px;
            font-size: 0.85em;
            opacity: 0.5;
        }
        .my_message
        {
            justify-content: flex-end;
        }
        .frnd_message
        {
            justify-content: flex-start;
        }
        .frnd_message p
        {
            background: #fff;
            text-align: left;
        }
        .message.frnd_message p::before
        {
            content: '';
            position: absolute;
            top: 0;
            left: -12px;
            width: 20px;
            height: 20px;
            background: linear-gradient(225deg,#fff 0%,#fff 50%,transparent 50%,transparent);
        }
        .chatbox_input
        {
            position: absolute;
            width: 100%;
            height: 110px;
            background: #f0f0f0;
            padding: 15px;
            justify-content: space-between;
            bottom: 0;
            align-items: center;
        }
        .chatbox_input input
        {
            position: relative;
            width: 90%;

            margin: 0 20px;
            padding: 10px 20px;
            border: none;
            outline: none;
            border-radius: 30px;
            font-size: 1em;
        }
    </style>

</head>
<body >
<div class="container" id="container">
    <div class="leftSide">
        <!--header-->
        <div class="header">
            <div class="userimg">
                <img src= "../img/profile.jpg" class="cover">
            </div>
        </div>
        <div class="search_chat">
            <div>
                <input type="text" placeholder="搜索..." id="search" @change="searchUser()">
            </div>
        </div>
        <div class="chatlist" id="chatlist">
            <div class="block active" v-for="user in users" @click="getUser(user)" >
                <div class="imgbx">
                    <img :src="'../'+user.userImg" class="cover">
                </div>
                <div class="details">
                    <div class="listHead">
                        <h4>{{user.nickname}}</h4>
                        <p class="time">{{user.chatMsg.creatTime}}</p>
                        <!--						<span class="badge">{{user.unreadNumber}}</span>-->
                    </div>
                    <div class="message_p">
                        <p>{{user.chatMsg.content}}</p>
                        <template v-if="user.unreadNumber>0">
                            <span :id="user.userId" class="badge" style="display:block" >{{user.unreadNumber}}</span>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="rightSide">
        <div class="header">
            <div class="imgText">
                <div class="userimg">
                    <template v-if="sign">
                        <img :src="'../'+selected.userImg" class="cover">
                    </template>
                </div>
                <h4>{{selected.nickname}}<br>
                    <template v-if="selected.status == '1'">
                        <span>在线</span>
                    </template>
                    <template v-if="selected.status == '0'">
                        <span>离线</span>
                    </template>
                </h4>

            </div>
        </div>
        <div class="chatBox"  id="message">
        </div>
        <div class="chatbox_input">
            <div class="instrument">
                <img src="../img/picture.png" width="30px" height="30px" onclick="file.click()" style="margin-left: 100px">
                <input type="file" id="file" name="upload_image" accept="image/gif, image/jpeg, image/png, image/jpg" hidden>
                <img src="../img/over.png" width="30px" height="30px" @click="removeFriend()" style="margin-left: 100px" title="结束通话">
            </div>
            <div>
                <input type="text" width="200px" id="msg">
                <img src="../img/sender.png" width="30" alt="图片" onclick="send()">
            </div>

        </div>
    </div>
</div>
<th:block th:include="include :: footer"/>
<script th:src="@{/js/chat/base.js}"></script>
<script th:src="@{/js/chat/jquery.js}"></script>
<script th:src="@{/js/chat/quick_links.js}"></script>
<script th:src="@{/js/chat/vue.js}"></script>
<script th:src="@{/js/chat/axios.min.js}"></script>
<script type="text/javascript">

    var vm = new Vue({
        el:"#container",
        data:{
            token:"",
            username:"",
            userImg:"",
            websocket:"",
            users:[],
            selected:"",
            toUser:"",
            msg:[],
            userImg:"",
            userId:"",
            oldUsers:"",
            sign: 0

        },
        created:function() {
            //从cookie中获取token、username、userImg

            var username = getCookieValue("cpsname");
            var userId = "";
            var url1 = baseUrl+"chat/userRelation/"+username;
            axios({
                url:url1,
                method:"get",
            }).then((res)=>{
                if(res.data.code == 10000){
                    userId = res.data.data;
                    this.userId = res.data.data;
                    this.createWeb(userId);
                    this.getUserList();
                    console.log(this.userId);
                }else {
                    alert("注册失败，请联系管理员进行操作！");
                }
            });
            var nickname = userId

        },
        methods: {
            removeFriend:function (){
                var r = confirm("确定要结束服务吗？")
                if (r == true) {
                    var url2 = baseUrl+"chat/removeFriend";
                    var ChatMsg = {sendId:this.userId,receiveId:this.selected.userId};
                    axios({
                        url:url2,
                        method:"post",
                        data: ChatMsg
                    }).then((res)=>{
                        if(res.data.code == 10000){
                            //请求成功  [{commonType:0},{commonType:1}]
                            for(var i=0; i<this.users.length; i++) {
                                if(this.users[i].userId==this.selected.userId){
                                    this.users.splice(i, 1);
                                }
                            }
                        }
                    });
                } else {
                    return;
                }
            },
            createWeb:function (nickname){
                if ('WebSocket'in window) {
                    this.websocket = new WebSocket(webSocketBaseUrl+"CustomerSocket/"+nickname);
                } else {
                    alert('Not support websocket')
                }
                //连接发生错误的回调方法
                this.websocket.onerror = function() {
                    setMessageInnerHTML("error");
                };
                //连接成功建立的回调方法
                this.websocket.onopen = function(event) {
                    // setMessageInnerHTML("Loc MSG: 成功建立连接");
                }
                //接收到消息的回调方法
                this.websocket.onmessage = function(event) {
                    var message = event.data.split(":");
                    if(message[0]==vm.selected.userId){
                        setMessageInnerHTML(message[1]);
                        addMessage(message,0);
                    }else {
                        addMessage(message,1);
                    }
                }
                //连接关闭的回调方法
                this.websocket.onclose = function() {
                    setMessageInnerHTML("Loc MSG:关闭连接");
                }
                //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
                window.onbeforeunload = function() {
                    this.websocket.close();
                }
            },
            getUserList:function (){
                var url2 = baseUrl+"chat/userList/"+this.userId;
                axios({
                    url:url2,
                    method:"get",
                    params:{
                        userId:this.userId
                    },
                }).then((res)=>{
                    if(res.data.code == 20001 || res.data.code == 20002){
                        //跳转登录
                    }else if(res.data.code == 10000){
                        //请求成功  [{commonType:0},{commonType:1}]
                        this.users = res.data.data;
                        this.oldUsers = res.data.data;
                        if(this.users.length>=1){
                            this.sign = 1;
                            this.selected = this.users[0];
                        }
                        for(var i=0; i<this.users.length; i++) {
                            var date = new Date(this.users[i].chatMsg.creatTime);
                            var hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
                            var minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
                            // var second = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
                            var time =  hour+":"+minute;
                            this.users[i].chatMsg.creatTime = time;
                            if(this.users[i].chatMsg.content.includes("jpg")||this.users[i].chatMsg.content.includes("png")||this.users[i].chatMsg.content.includes("JPG")||this.users[i].chatMsg.content.includes("PNG")) {
                                this.users[i].chatMsg.content="【图片】";
                            }
                        }
                        console.log(this.users);
                    }
                });
            },
            searchUser:function (){
                document.getElementById('chatlist').value="";
                var information = document.getElementById('search').value;
                if(information==""||information==null){
                    this.users = this.oldUsers;
                }else{
                    var url1 = baseUrl+"chat/getUserByDetail/"+information;
                    axios({
                        url:url1,
                        method:"get",
                    }).then((res)=>{
                        if(res.data.code == 10000){
                            //请求成功  [{commonType:0},{commonType:1}]
                            vm.users = res.data.data;
                            for(var i=0; i<this.users.length; i++) {
                                var date = new Date(this.users[i].chatMsg.creatTime);
                                var hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
                                var minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
                                // var second = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
                                var time =  hour+":"+minute;
                                this.users[i].chatMsg.creatTime = time;
                            }
                            console.log("users",vm.users);

                        }
                    });
                }

            },
            getUser: function (user){
                document.getElementById('message').innerHTML = "";
                this.selected = user;
                var url1 = baseUrl+"chat/msgHistory";
                user.unreadNumber=0;
                var ChatMsg = {sendId:"0",receiveId:user.userId};
                axios({
                    url:url1,
                    method:"post",
                    data: ChatMsg
                }).then((res)=>{
                    if(res.data.code == 10000){
                        //请求成功  [{commonType:0},{commonType:1}]
                        this.msg = res.data.data;
                        console.log("msg",this.msg);
                        for(var i=0; i<this.msg.length; i++) {
                            creatMsg(this.msg[i]);
                        }
                    }
                });
                var url2 = baseUrl+"chat/msgRead";
                var ChatMsg = {sendId:user.userId,receiveId:"0"};
                axios({
                    url:url2,
                    method:"post",
                    data: ChatMsg
                }).then((res)=>{
                    if(res.data.code == 10000){
                        //请求成功  [{commonType:0},{commonType:1}]
                    }
                });
            }
        }
    });
    function addMessage(message,t){
        var user = 0;
        for(var i=0;i<vm.users.length;i++){
            if(vm.users[i].userId==message[0]){
                user = 1;
                vm.users[i].chatMsg.content=message[1];
                var date = new Date();
                var hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
                var minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
                var time =  hour+":"+minute;
                vm.users[i].chatMsg.creatTime = time;
                vm.users[i].status='1';
                if(t==1){
                    vm.users[i].unreadNumber=vm.users[i].unreadNumber+1;
                }
            }
        }
        if(user==0){
            var url1 = baseUrl+"chat/getUserByDetail/"+message[0];
            axios({
                url:url1,
                method:"get",
            }).then((res)=>{
                if(res.data.code == 10000){
                   var customer = res.data.data;
                   var date = new Date();
                   var hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
                   var minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
                   var time =  hour+":"+minute;
                   customer[0].chatMsg.creatTime = time;
                   customer[0].chatMsg.content = message[1];
                   customer[0].unreadNumber = 1;
                   customer[0].status='1';
                   vm.oldUsers.push(customer[0]);
                   if(vm.oldUsers.length==1){
                       vm.selected = customer[0];
                   }
                   vm.users = vm.oldUsers;
                }
            });
        }
    }
    function setMessageInnerHTML(innerHTML) {
        var div = document.createElement("div");

        //为div创建属性class = "test"
        var divattr = document.createAttribute("class");
        divattr.value = "message frnd_message";

        //把属性class = "test"添加到div
        div.setAttributeNode(divattr);
        if(innerHTML.includes("jpg")||innerHTML.includes("png")||innerHTML.includes("JPG")||innerHTML.includes("PNG")){
            var span = document.createElement("span");
            var date = new Date();
            var hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
            var minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
            var second = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
            span.innerHTML += hour+":"+minute+":"+second;
            var img = document.createElement("img");
            img.setAttribute("src", innerHTML);
            div.appendChild(img);
            div.appendChild(span);
        }else{
            var text = document.createElement("p");
            var span = document.createElement("span");
            var date = new Date();
            var hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
            var minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
            var second = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
            span.innerHTML +=  hour+":"+minute+":"+second;
            text.innerHTML +=innerHTML + '<br/>';
            text.appendChild(span);
            div.appendChild(text)
        }
        // document.getElementById('message').innerHTML += innerHTML + '<br/>';
        document.getElementById('message').appendChild(div)
    }
    //关闭连接
    function closeWebSocket() {
        websocket.close();
    }
    //发送消息
    //发送消息
    function send() {
        //获取输入的文本信息进行发送
        var message = document.getElementById('msg').value;
        document.getElementById('msg').value="";
        // var toUser = document.getElementById('toUser').value;
        var toUser = vm.selected.userId;
        var ChatMsg = {content:message,receiveId:toUser};
        vm.websocket.send(JSON.stringify(ChatMsg));
        var div = document.createElement("div");

        //为div创建属性class = "test"
        var divattr = document.createAttribute("class");
        divattr.value = "message my_message";

        //把属性class = "test"添加到div
        div.setAttributeNode(divattr);
        var text = document.createElement("p");
        var span = document.createElement("span");
        var date = new Date();
        var hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
        var minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
        var second = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
        span.innerHTML += hour+":"+minute+":"+second;
        text.innerHTML +=message + '<br/>';
        text.appendChild(span);
        div.appendChild(text)
        // document.getElementById('message').innerHTML += innerHTML + '<br/>';
        document.getElementById('message').appendChild(div)
    }
    function creatMsg(message){
        var div = document.createElement("div");
        //为div创建属性class = "test"
        var divattr = document.createAttribute("class");
        if(message.sendId=="0"){
            divattr.value = "message my_message";
        }else {
            divattr.value = "message frnd_message";
        }
        div.setAttributeNode(divattr);
        if(message.content.includes("jpg")||message.content.includes("png")||message.content.includes("JPG")||message.content.includes("PNG")){
            var span = document.createElement("span");
            var date = new Date(message.creatTime);
            var hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
            var minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
            var second = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
            span.innerHTML += hour+":"+minute+":"+second;
            var img = document.createElement("img");
            img.setAttribute("src", message.content);
            div.appendChild(img);
            div.appendChild(span);
        }else{
            var text = document.createElement("p");
            var span = document.createElement("span");
            var date = new Date(message.creatTime);
            var hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
            var minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
            var second = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
            span.innerHTML += hour+":"+minute+":"+second;
            text.innerHTML +=message.content + '<br/>';
            text.appendChild(span);
            div.appendChild(text)
        }
        document.getElementById('message').appendChild(div)
    }
    function getCookieValue(keyStr){
        var operator = "=";
        var value = null;
        var s = window.document.cookie;
        var arr = s.split("; ");
        for(var i=0; i<arr.length; i++){
            var str = arr[i];
            var k = str.split(operator)[0];
            var v = str.split(operator)[1];
            if(k == keyStr){
                value = v;
                break;
            }
        }
        return value;
    }
</script>
<script type="text/javascript">
    let fileInput = document.getElementById('file');
    // 监听change事件:
    fileInput.addEventListener('change', function() {
        // 清除背景图片:
        // preview.style.backgroundImage = '';
        if (!fileInput.value) {
            info.innerHTML = '没有选择文件';
            return;
        }
        let file = fileInput.files[0];
        let size = file.size;
        if (size >= 1 * 1024 * 1024) {
            alert('文件大小超出限制');
            info.innerHTML = '文件大小超出限制';
            return false;
        }
        // 获取File信息:
        // info.innerHTML = `文件名称:  + ${file.name}<br>文件大小: ${file.size} <br>上传时间: ${file.lastModifiedDate}`;
        if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
            alert('不是有效的图片文件!');
            return;
        }
        console.log( "res.data.data");
        // 读取文件:
        let reader = new FileReader();
        reader.onload = function(e) {
            let data = e.target.result;
            var div = document.createElement("div");
            //为div创建属性class = "test"
            var divattr = document.createAttribute("class");
            divattr.value = "message my_message";
            //把属性class = "test"添加到div
            div.setAttributeNode(divattr);
            // var text = document.createElement("p");
            var span = document.createElement("span");
            var date = new Date();
            var hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
            var minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
            var second = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
            span.innerHTML += hour+":"+minute+":"+second;
            var img = document.createElement("img");
            img.setAttribute("src", data);
            div.appendChild(img);
            div.appendChild(span);
            document.getElementById('message').appendChild(div)
        };
        // 以DataURL的形式读取文件:
        reader.readAsDataURL(file);
        //将照片传输到后台
        var formdata = new FormData();
        // formdata.append("name", fileInput.files[0].name);
        formdata.append("image", fileInput.files[0]);
        console.log(fileInput.files[0].name);
        var url5 = baseUrl+"chat/sendImg"
        axios({
            url:url5,
            method:"put",
            contentType:"multipart/form-data",
            data:formdata,

        }).then((res)=>{
            if(res.data.code == 10000){
                var message = res.data.data;
                var toUser = vm.selected.userId;
                var ChatMsg = {content:message,receiveId:toUser};
                vm.websocket.send(JSON.stringify(ChatMsg));
            }
        });
    });

</script>
</body>

</html>